## Migrations

[Flask-migrate](https://flask-migrate.readthedocs.io/en/latest/#example) package is used to perform migration for PostgreSQL database.
Flask-migrate is built on top of [alembic](https://alembic.sqlalchemy.org/en/latest/) package and provides bindings to use together with flask.

There is a dedicated entrypoint in order to perform database version migrations - `migrations/migration.py`. It loads application context and
initializes database.

### Initialize

At the first run clean database should be used. Also Workbench's env variables should be set and venv activated.

Command:
```
FLASK_APP=migrations/migration:APP flask db upgrade
```

Will create database schema and put current migration version under `alembic_version` table.


### Create migration

After some changes made to the SqlAlchemy models a new migration script should be created.

Command:
```
FLASK_APP=migrations/migration:APP flask db migrate -m 'migration description'
```
Will create a new migration script under `migrations/versions/`. Alembic will try to automatically detect difference between
database schema and models. Based on this diff it will generate a schema migration script.

There are several constraints with autogenerated script:
* It cannot detect all schema changes, for example tables and columns name changes. That's why all changes should be manually
checked.
* It cannot create a data migrations. All data migrations should be created manually.

### Upgrade database version

After a new migration created it needs to be applied.

Command:
 ```
FLASK_APP=migrations/migration:APP flask db upgrade
```

Will check the database version under `alembic_version` table, detect migrations under `migrations/versions` which were not applied and will apply them.
